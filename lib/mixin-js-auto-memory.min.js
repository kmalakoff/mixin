// Generated by CoffeeScript 1.3.3

/*
  mixin_auto_memory.js
  (c) 2011, 2012 Kevin Malakoff.
  Mixin.AutoMemory is freely distributable under the MIT license.
  See the following for full license details:
    https://github.com/kmalakoff/mixin/blob/master/LICENSE
  Dependencies: Mixin.Core, Underscore.js, Underscore-Awesomer.js
*/(function(){var e,t;e=!window.Mixin&&typeof require!="undefined"?require("mixin-js-core"):window.Mixin;if(typeof require!="undefined")try{t=require("lodash")}catch(n){t=require("underscore")}else t=this._;t&&t.hasOwnProperty("_")&&(t=t._),t||(t=e._),e.AutoMemory||(e.AutoMemory={}),e.AutoMemory.root=this,e.AutoMemory.WRAPPER=e.AutoMemory.root.$?$:"$",e.AutoMemory.Property=function(){function n(e){this.owner=e}return n.prototype.setArgs=function(){var n,r,i,s,o;if(!arguments.length)throw new Error("Mixin.AutoMemory: missing key");this.args=Array.prototype.slice.call(arguments);if(!e.DEBUG)return this;if(t.isArray(this.args[0])){s=this.args,o=[];for(r=0,i=s.length;r<i;r++)n=s[r],o.push(this._validateEntry(n));return o}return this._validateEntry(this.args)},n.prototype.destroy=function(){var e,n,r,i,s;if(t.isArray(this.args[0])){i=this.args,s=[];for(n=0,r=i.length;n<r;n++)e=i[n],s.push(this._destroyEntry(e));return s}return this._destroyEntry(this.args)},n.prototype._validateEntry=function(e){var n,r;r=e[0],n=e.length>1?e[1]:void 0;if(!t.keypathExists(this.owner,r))throw new Error("Mixin.AutoMemory: property '"+r+"' doesn't exist on '"+t.classOf(this.owner)+"'");if(n&&!t.isFunction(n)&&!t.isString(n))throw new Error("Mixin.AutoMemory: unexpected function reference for property '"+r+"' on '"+t.classOf(this.owner)+"'")},n.prototype._destroyEntry=function(e){var n,r,i,s,o,u,a,f;r=e[0],n=e.length>1?e[1]:void 0;if(!n){i=t.keypathValueOwner(this.owner,r);if(!i)throw new Error("Mixin.AutoMemory: property '"+r+"' doesn't exist on '"+t.classOf(this.owner)+"'");i[r]=null;return}o=t.keypath(this.owner,r);if(!o)return;if(t.isFunction(n))n.apply(this.owner,[o].concat(e.length>2?e.slice(2):[]));else if(t.isFunction(o[n]))o[n].apply(o,e.length>2?e.slice(2):[]);else{f=e.slice(1);for(u=0,a=f.length;u<a;u++)s=f[u],this._destroyEntry([s])}return t.keypath(this.owner,r,null)},n}(),e.AutoMemory.WrappedProperty=function(){function n(n,r,i,s){var o,u,a;this.owner=n,this.key=r,this.fn_ref=i,this.wrapper=s;if(this.fn_ref&&t.isArray(this.fn_ref)){if(e.DEBUG&&!this.fn_ref.length)throw new Error("Mixin.AutoMemory: unexpected function reference");this.args=this.fn_ref.splice(1),this.fn_ref=this.fn_ref[0]}if(!e.DEBUG)return this;if(!this.key)throw new Error("Mixin.AutoMemory: missing key");if(t.isArray(this.key)){a=this.key;for(o=0,u=a.length;o<u;o++){r=a[o];if(!t.keypathExists(this.owner,r))throw new Error("Mixin.AutoMemory: property '"+r+"' doesn't exist on '"+t.classOf(this.owner)+"'")}}else if(!t.keypathExists(this.owner,this.key))throw new Error("Mixin.AutoMemory: property '"+this.key+"' doesn't exist on '"+t.classOf(this.owner)+"'");if(this.fn_ref&&!t.isFunction(this.fn_ref)&&!t.isString(this.fn_ref))throw new Error("Mixin.AutoMemory: unexpected function reference");if(!this.wrapper)throw new Error("Mixin.AutoMemory: missing wrapper")}return n.prototype.destroy=function(){var e,n,r,i,s;if(t.isArray(this.key)){i=this.key,s=[];for(n=0,r=i.length;n<r;n++)e=i[n],s.push(this._destroyKey(e));return s}return this._destroyKey(this.key)},n.prototype._destroyKey=function(n){var r,i,s;if(!this.fn_ref){t.keypath(this.owner,n,null);return}r=t.keypath(this.owner,n);if(!r)return;s=t.isString(this.wrapper)?e.AutoMemory.root[this.wrapper]:this.wrapper,i=s(r);if(t.isFunction(this.fn_ref))this.fn_ref.apply(this.owner,[i].concat(this.args?this.args.slice():[]));else{if(e.DEBUG&&!t.isFunction(i[this.fn_ref]))throw new Error("Mixin.AutoMemory: function '"+this.fn_ref+"' missing for wrapped property '"+n+"' on '"+t.classOf(this.owner)+"'");i[this.fn_ref].apply(i,this.args)}return t.keypath(this.owner,n,null)},n}(),e.AutoMemory.Function=function(){function n(n,r,i){this.object=n,this.fn_ref=r,this.args=i;if(!e.DEBUG)return this;if(!this.fn_ref)throw new Error("Mixin.AutoMemory: missing fn_ref");if(!t.isFunction(this.fn_ref)&&!(this.object&&t.isString(this.fn_ref)&&t.isFunction(this.object[this.fn_ref])))throw new Error("Mixin.AutoMemory: unexpected function reference")}return n.prototype.destroy=function(){if(!this.object){this.fn_ref.apply(null,this.args);return}if(!t.isFunction(this.fn_ref)){this.object[this.fn_ref].apply(this.object,this.args);return}return this.fn_ref.apply(this.object,[this.object].concat(this.args?this.args.slice():[]))},n}(),e.AutoMemory._mixin_info={mixin_name:"AutoMemory",initialize:function(){return e.instanceData(this,"AutoMemory",[])},destroy:function(){var t,n,r,i,s;n=e.instanceData(this,"AutoMemory"),e.instanceData(this,"AutoMemory",[]),s=[];for(r=0,i=n.length;r<i;r++)t=n[r],s.push(t.destroy());return s},mixin_object:{autoProperty:function(t,n){var r;return r=new e.AutoMemory.Property(this),r.setArgs.apply(r,arguments),e.instanceData(this,"AutoMemory").push(r),this},autoWrappedProperty:function(t,n,r){return r===void 0&&(r=e.AutoMemory.WRAPPER),e.instanceData(this,"AutoMemory").push(new e.AutoMemory.WrappedProperty(this,t,n,r)),this},autoFunction:function(t,n){return e.instanceData(this,"AutoMemory").push(new e.AutoMemory.Function(t,n,Array.prototype.slice.call(arguments,2))),this}}},e.registerMixin(e.AutoMemory._mixin_info)}).call(this);